# playbook based on Mark Stillwell's multi-deployment pattern
# see: http://blog.stillwell.me/blog/2015/06/09/multi-environment-deployments-with-ansible/
---
- set_fact:
    ansible_distro: "{{ ansible_distribution|lower|replace('\"', '') }}"

- name: gather os specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distro }}-{{ ansible_distribution_version|lower|replace('/', '_') }}.yml"
        - "{{ ansible_distro }}-{{ ansible_distribution_release }}.yml"
        - "{{ ansible_distro }}-{{ ansible_distribution_major_version|lower|replace('/', '_') }}.yml"
        - "{{ ansible_distro }}.yml"
        - "{{ ansible_os_family|lower }}.yml"
        - defaults.yml
      paths:
        - ../vars

- name: update installed packages
  package: name=* state=latest

- name: remove IPv6 address for localhost
  lineinfile: dest=/etc/hosts regexp='^::1' state=absent

# FIXME is this really necessary?
- name: add IPv4 address for localhost
  lineinfile: dest=/etc/hosts regexp='^127.0.0.1\s' line='127.0.0.1 localhost'

- name: remove any existing gluster packages
  package:
    name: "{{ item }}"
    state: absent
  with_items: glusterfs_server_package_info.del_pkgs
  when: glusterfs_server_package_info.del_pkgs|length > 0

- name: install pre-requisite packages
  package:
    name: "{{ item }}"
    state: latest
  with_items: glusterfs_server_package_info.pre_pkgs
  when: glusterfs_server_package_info.pre_pkgs|length > 0

- name: os/vendor tweaks/packages
  include: "{{ item }}"
  with_first_found:
    - files:
      - "{{ ansible_distro }}-{{ ansible_distribution_version|lower|replace('/', '_') }}.yml"
      - "{{ ansible_distro }}-{{ ansible_distribution_release }}.yml"
      - "{{ ansible_distro }}-{{ ansible_distribution_major_version|lower|replace('/', '_') }}.yml"
      - "{{ ansible_distro }}.yml"
      - "{{ ansible_os_family|lower }}.yml"
      skip: true

- name: disable services
  service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  with_items: glusterfs_server_services.disabled
  when: glusterfs_server_services.disabled|length > 0

# FIXME clean this up to suport xfs, btrfs, zfs
- name: Format backend
  filesystem: fstype=xfs dev=/dev/vdb

- name: Add entry to fstab and mount
  mount: name=/d src=/dev/vdb fstype=xfs state=mounted
